var DATA = [{"path": "MyProject01_zln.html", "reviews": [{"comment": "# \u5efa\u8bae 1 \u2728 (\u505a\u5f97\u4e0d\u9519\u7684\u70b9) \n---------\n \u4f7f\u7528 `<h1>`, `<h2>` \u7b49`heading`\u6807\u7b7e\u53bb\u505a\u6807\u9898\ud83d\udc4d\r\n\r\n[\u66f4\u591a\u6709\u5173\u4e8e\u6807\u9898\u7684\u6807\u7b7e\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u70b9\u51fb\u8fd9\u91cc\u53bb\u4e86\u89e3](https://developer.mozilla.org/en-US/docs/Web/HTML\u00e5/Element/Heading_Elements) \n# \u5efa\u8bae 2 \u2728 (\u505a\u5f97\u4e0d\u9519\u7684\u70b9) \n---------\n \u4f7f\u7528 `<h1>`, `<h2>` \u7b49`heading`\u6807\u7b7e\u53bb\u505a\u6807\u9898\ud83d\udc4d\r\n\r\n[\u66f4\u591a\u6709\u5173\u4e8e\u6807\u9898\u7684\u6807\u7b7e\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u70b9\u51fb\u8fd9\u91cc\u53bb\u4e86\u89e3](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Heading_Elements) \n", "rate": "awesome", "description": "1 (\u505a\u5f97\u4e0d\u9519\u7684\u70b9): \u8d5e\uff1aheading \u6807\u7b7e\u4f7f\u7528\n2 (\u505a\u5f97\u4e0d\u9519\u7684\u70b9): \u8d5e\uff1aheading \u6807\u7b7e\u4f7f\u7528\n", "lineNum": 8}, {"comment": "# \u5efa\u8bae 1 \u2728  \n---------\n \u5bf9\u4e8e\u6709\u5e8f\u7684\u6392\u5217\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 [<ol>](https://www.w3schools.com/tags/tag_ol.asp) \u6807\u7b7e\u505a\r\n\r\n# \u8b6c\u5982\uff1a\r\n\u6570\u5b57\uff0c\u5176\u4e2d\u7684 `start=\"1\"` \u4ee3\u8868\u4ece 1 \u5f00\u59cb\u8fdb\u884c\u6392\u5217\u3002\u800c `<li>` \u6807\u7b7e\u5305\u62ec\u7684\u5219\u662f\u6bcf\u4e00\u4e2a\u5217\u8868\u9879\r\n```\r\n<ol start=\"1\">\r\n  <li>\u5496\u5561</li>\r\n  <li>\u8336</li>\r\n  <li>\u725b\u5976</li>\r\n</ol>\r\n```\r\n\r\n\u82e5\u679c\u4f7f\u7528\u5b57\u6bcd\u8fdb\u884c\u6392\u5e8f\uff0c\u5219\u53ef\u4ee5\u8bbe\u7f6e `type` \u5c5e\u6027\u7684\u503c\u4e3a `A`\r\n```\r\n<ol type=\"A\" start=\"1\">\r\n  <li>\u5496\u5561</li>\r\n  <li>\u8336</li>\r\n  <li>\u725b\u5976</li>\r\n</ol>\r\n```\r\n\r\n\u4e0a\u9762\u4e24\u6bb5\u4ee3\u7801\u7684\u7f51\u9875\u6548\u679c\uff1a\r\n```\r\n1. \u5496\u5561\r\n2. \u8336\r\n3. \u725b\u5976\r\n```\r\n```\r\nA. \u5496\u5561\r\nB. \u8336\r\nC. \u725b\u5976\r\n```\r\n\r\n## \u63a8\u8350\u9605\u8bfb\u6587\u6863\uff1a\r\n- [ol\u6807\u7b7e](https://www.w3schools.com/tags/tag_ol.asp) \n# \u5efa\u8bae 2 \u2728  \n---------\n \u8fd9\u91cc\u7684\u7ed3\u675f\u6807\u7b7e\u4f4d\u7f6e\u9700\u8981\u6539\u5584\u4e00\u4e0b\uff1a\r\n\r\n\u6b63\u786e\u7684\u987a\u5e8f\u5e94\u8be5\u8ddf\u5b83\u4eec\u7684 `\u5f00\u59cb\u6807\u7b7e` \u9006\u987a\u5e8f\uff1a\r\n```\r\n<b><em>.........</em></b>\r\n```\r\n\r\n\u5728\u5199\u4ee3\u7801\u7684\u65f6\u5019\uff0c\u5f88\u5bb9\u6613\u5c06\u7ed3\u675f\u6807\u7b7e\u7684\u4f4d\u7f6e\u5199\u9519\uff5e \u5982\u679c\u613f\u610f\u7684\u8bdd\uff0c\u5728\u5199\u5b8c HTML \u4ee3\u7801\u540e\uff0c\u5efa\u8bae\u5c06\u4ee3\u7801\u7528 [\u8fd9\u4e2a\u7f51\u7ad9](http://validator.w3.org/#validate_by_input) \u68c0\u67e5\u4e00\u4e0b \n", "rate": "suggestion", "description": "1 : \u5efa\u8bae\uff1a\u4f7f\u7528 ol \u505a\u6709\u5e8f\u5217\u8868\u9879\n2 : \u5efa\u8bae\uff1ab\u548cem\u7684\u5d4c\u5957\u4e0d\u6b63\u786e\n", "lineNum": 10}, {"comment": "\u5bf9\u4e8e\u4e0d\u9700\u7279\u522b\u6392\u5217\u7684\u5217\u8868\u9879\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 [<ul>](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/ul) \u5b9e\u73b0\r\n\r\n\u8b6c\u5982\uff1a\u4e00\u53ea\u9e1f \ud83d\udc26  \u5177\u6709\u7279\u6027\uff1a\u80fd\u98de\u7fd4\uff0c\u6709\u52a8\u542c\u7684\u58f0\u97f3\uff0c\u52e4\u594b\r\n\r\n\u4ee3\u7801\uff1a\r\n```\r\n<ul>\r\n  <li>\u80fd\u98de\u7fd4</li>\r\n  <li>\u6709\u52a8\u542c\u7684\u58f0\u97f3</li>\r\n  <li>\u52e4\u594b</li>\r\n</ul>\r\n```\r\n\r\n\u7f51\u9875\u6548\u679c\uff1a\r\n\r\n- \u80fd\u98de\u7fd4\r\n- \u6709\u52a8\u542c\u7684\u58f0\u97f3\r\n- \u52e4\u594b", "rate": "suggestion", "description": "\u5efa\u8bae: \u4f7f\u7528 ul \u6807\u7b7e\u53bb\u505a\u65e0\u5e8f\u5217\u8868", "lineNum": 3}, {"comment": "\u7528 `<head>` \u6807\u7b7e\u5b9a\u4e49\u6587\u6863\u7684\u5934\u90e8\uff0c\u5f88\u8d5e\u7684\u505a\u6cd5\ud83d\udc4d \r\n\r\n`<head>` \u662f\u63d0\u4f9b\u4e00\u4e9b\u6d4f\u89c8\u5668\u4e3a\u4e86\u751f\u6210\u7f51\u53cb\u9700\u8981\u7684\u4fe1\u606f\uff0c\u8b6c\u5982\uff1a\u5728\u54ea\u91cc\u5f15\u7528\u811a\u672c\u3001\u6307\u793a\u6d4f\u89c8\u5668\u5728\u54ea\u91cc\u627e\u5230\u6837\u5f0f\u8868\u3001\u7528\u4ec0\u4e48\u7684\u5b57\u7b26\u53bb\u89e3\u6790\u7f51\u9875\r\n\r\n\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 `<meta>` \u6807\u7b7e,\u4f7f\u5f97\u6d4f\u89c8\u5668\u80fd\u591f\u7528 utf-8 \u53bb\u89e3\u6790\u4e2d\u6587\u3002\u4ece\u800c\u80fd\u5728 Html \u91cc\u6709\u4e2d\u6587\u65f6\uff0c\u7f51\u9875\u663e\u793a\u51fa\u6765\u7684\u4e0d\u662f**\u4e71\u7801**\uff5e\r\n\r\n\u4f7f\u7528 [utf-8](http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html) \u7684\u5b57\u7b26\u96c6\u6765\u89e3\u6790\u8fd9\u4e2a `HTML` \u7684\u6587\u6863, \r\n```\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <title>\u6807\u9898</title>\r\n</head>\r\n``` ", "rate": "awesome", "description": "\u7f3a: meta, utf-8", "lineNum": 5}, {"comment": "HTML \u6807\u7b7e\u7684\u6b63\u786e\u5d4c\u5957\uff0c\u505a\u5f97\u5f88\u68d2\uff01\r\n\r\n\u8b6c\u5982\u4e0b\u9762\u7684\u5d4c\u5957\u9519\u8bef\u5c31\u5f88\u5bb9\u6613\u51fa\u73b0\uff0c\u5f97\u7559\u610f\u9632\u6b62\u8fd9\u79cd\u60c5\u51b5\u51fa\u73b0\u3002\u5982\u679c\u613f\u610f\u7684\u8bdd\uff0c\u5728\u5199\u5b8c HTML \u4ee3\u7801\u540e\uff0c\u5efa\u8bae\u5c06\u4ee3\u7801\u7528 [\u8fd9\u4e2a\u7f51\u7ad9](http://validator.w3.org/#validate_by_input) \u68c0\u67e5\u4e00\u4e0b\r\n\r\n\u6709\u9519\u8bef\u7684\u683c\u5f0f\uff1a\r\n```\r\n    <p>\u6211<strong>\u771f\u7684</p>\u662f\u8fd9\u4e2a\u610f\u601d</strong>\r\n``` ", "rate": "awesome", "description": "\u8d5e\uff1ap\u6807\u7b7e\u5d4c\u5957", "lineNum": 87}]}];
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

var Repeat = function(time, func) {
    this.time = time;
    this.func = func; 
    this.isEnd = false;
    this.index = 0;
};

Repeat.prototype.repeateInInterval = function (){
    var self = this;
    if (self.isEnd === true) {
        return;
    }
    sleep(self.time).then(() => {
        self.func();
        self.repeateInInterval();
    });
};

Repeat.prototype.repeateWithIndex = function (totalTime) {
    var self = this;
    if (self.index > totalTime || self.isEnd === true){
        return;
    }
    sleep(self.time).then(() => {
        self.func(self.index);
        self.index = self.index + 1;
        self.repeateWithIndex(totalTime);
    });
};

var ReviewData = function(data) {
    this.data = data;
};

ReviewData.prototype.getDatasLength = function() {
    return this.data.length;
};

ReviewData.prototype.getReviewsLength = function(pathIndex) {
    return this.data[pathIndex].reviews.length;
};

ReviewData.prototype.getPath = function (pathIndex) {
    return this.data[pathIndex].path;
};

ReviewData.prototype.getReview = function (pathIndex, reviewIndex) {
    return this.data[pathIndex].reviews[reviewIndex];
};

ReviewData.prototype.getLineNum = function (pathIndex, reviewIndex) {
    return this.getReview(pathIndex, reviewIndex).lineNum;
};

ReviewData.prototype.getLineComment = function (pathIndex, reviewIndex) {
    return this.getReview(pathIndex, reviewIndex).comment;
};

ReviewData.prototype.getDescription = function (pathIndex, reviewIndex) {
    return this.getReview(pathIndex, reviewIndex).description;
};

ReviewData.prototype.getRate = function (pathIndex, reviewIndex) {
    var returnRate = RATE.awesome;
    switch (this.getReview(pathIndex, reviewIndex).rate){
    case "awesome":
        returnRate = RATE.awesome;
        break;
    case "suggestion":
        returnRate = RATE.suggestion;
        break;
    case "require":
        returnRate = RATE.require;
        break;
    default:
        console.log('error in getRate funtion');
    }
    
    return returnRate;
};

var AutoReview = function(reviewData){
    this.tab = "Code Review";
    this.pathIndex = 0;
    this.reviewIndex = 0;
    this.data = reviewData;
};

AutoReview.prototype.start = function () {
    var self = this;
    var mainRepeat = new Repeat();
    mainRepeat.time = 1000;
    mainRepeat.func = function () {
        if (isLoadedPageContent() === true) {
            clickTab(self.tab);
            self.selectFile();
            this.isEnd = true;
        }
    };
    mainRepeat.repeateInInterval();
};

AutoReview.prototype.selectFile = function(){
    var self = this;
    clickFile(this.data.getPath(this.pathIndex));

    var reviewRepeat = new Repeat(1000, function(){
        if (isLoadedCode() === true) {
            this.isEnd = true;
            self.selectCode();
        }
    });
    reviewRepeat.repeateInInterval();
};

AutoReview.prototype.selectCode = function () {
    var self = this;
    console.log("click code");
    mouseDownInCode(this.data.getLineNum(this.pathIndex,this.reviewIndex));

    var rateRepeat = new Repeat(1000, function () {
        if (isLoadedReviewRates() === true) {
            this.isEnd = true;
            self.comment();
        }
    });
    rateRepeat.repeateInInterval();
};

AutoReview.prototype.comment = function () {
    var self = this;
    var lineNum = this.data.getLineNum(this.pathIndex, this.reviewIndex);
    showMessage(this.data.getDescription(this.pathIndex, this.reviewIndex));
    reviewRate(this.data.getRate(this.pathIndex, this.reviewIndex));
    reviewComment(this.data.getLineComment(this.pathIndex,this.reviewIndex));
    clickSaveButton();
    console.log("comment");
    var saveRepeat = new Repeat(1000, function () {
        console.log("check saving: " + lineNum);
        if (isSavedComment(lineNum) === true) {
            console.log("is saved");
            this.isEnd = true;
            self.saved();
        }
    });
    saveRepeat.repeateInInterval();
};

AutoReview.prototype.saved = function () {
    if (this.reviewIndex < this.data.getReviewsLength(this.pathIndex) - 1) {
        this.reviewIndex += 1;
        this.selectCode();
    } else if (this.pathIndex < this.data.getDatasLength() - 1) {
        this.pathIndex += 1;
        this.reviewIndex = 0;
        this.selectFile();
    } else {
        console.log("finished");
    }
};
function clickTab(tabName) {
    $('.navbar-item').filter(function () {
        return $(this).text() == tabName;
    }).trigger("click");
}

function clickFile(fileName) {
    $('.code-section-item-title strong').filter(function () {
        return $(this).text() == fileName;
    }).trigger("click");
}

//创建鼠标事件
function mouseEvent(type, sx, sy, cx, cy) {
  var evt;
  var e = {
    bubbles: true,
    cancelable: (type != "mousemove"),
    view: window,
    detail: 0,
    screenX: sx, 
    screenY: sy,
    clientX: cx, 
    clientY: cy,
    ctrlKey: false,
    altKey: false,
    shiftKey: false,
    metaKey: false,
    button: 0,
    relatedTarget: undefined
  };
  if (typeof( document.createEvent ) == "function") {
    evt = document.createEvent("MouseEvents");
    evt.initMouseEvent(type, 
      e.bubbles, e.cancelable, e.view, e.detail,
      e.screenX, e.screenY, e.clientX, e.clientY,
      e.ctrlKey, e.altKey, e.shiftKey, e.metaKey,
      e.button, document.body.parentNode);
  } else if (document.createEventObject) {
    evt = document.createEventObject();
    for (prop in e) {
    evt[prop] = e[prop];
  }
    evt.button = { 0:1, 1:4, 2:2 }[evt.button] || evt.button;
  }
  return evt;
}

//传递事件
function dispatchEvent (el, evt) {
  if (el.dispatchEvent) {
    el.dispatchEvent(evt);
  } else if (el.fireEvent) {
    el.fireEvent('on' + type, evt);
  }
  return evt;
}

//点击第几行代码
function mouseDownInCode(lineNumber) {
    var codeElement = $(".CodeMirror-code").children().eq(lineNumber);
    var codeY = codeElement.offset().top - $(document).scrollTop();

    var event = mouseEvent("mousedown", 0, 0, 450, codeY);
    var elements = document.getElementsByClassName("CodeMirror-code");
    dispatchEvent(elements[0], event);
}

function isLoadedReviewRates () {
    var editor = $(".comment-editor:not(.ng-hide)");
    return editor.find("input").length !== 0;
}

//建议评价
function reviewRate(rate) {
    var editor = $(".comment-editor:not(.ng-hide)");
    editor.find("input").filter(function () {
        return $(this)[0].value == rate;
    }).click().click();
}

//review 的具体内容
function reviewComment(text) {
    var editor = $(".comment-editor:not(.ng-hide)");
    var textArea = editor.find("textarea");
    textArea[0].value = text;
    textArea.trigger('change');
}

function clickSaveButton() {
    $(".comment-container button").filter(function (){
        return $(this).attr("busy-click") == "submitComment()"; 
    }).click();
}

function isLoadedTab() {
    return $("#page-content .container-fluid").children().filter(function () {
        return $(this).attr("ng-show") == "loading";
    }).hasClass('ng-hide');
}

function isLoadedCode() {
    return $(".code-section-item-body .ng-isolate-scope").children().filter(function () {
        return $(this).attr("ng-show") == "isLoading";
    }).hasClass('ng-hide');
}

function isSavedComment(lineNumber) {
    var commentViewer = $(".CodeMirror-code").children().eq(lineNumber)
            .find(".CodeMirror-linewidget").find(".comment-viewer");
    if (commentViewer.length === 0) {
        return false;
    }
    var isSaved = !commentViewer.hasClass('ng-hide');
    return isSaved;
}

function isLoadedPageContent() {
    return $('#page-content .container-fluid').children().filter(function () {
        return $(this).attr("ng-show") == "loading";
    }).hasClass('ng-hide');
}

function showMessage(message) {
    console.log(message);
}

var RATE = {
    'awesome': 'awesome',
    'suggestion': 'nitpick',
    'require': 'critical'
};

// //例如：点击 Code Review 标签
// clickTab('Code Review');

// //点击文件
// clickFile('js/resources.js');

// //点击第 10 行的代码
// mouseDownInCode(10);

// //reviewRate
// reviewRate(RATE.awesome);

// //review comment
// reviewComment("hello,world");

// //click save button
// clickSaveButton();
var reviewData = new ReviewData(DATA);
var autoReview = new AutoReview(reviewData);
autoReview.start();
console.log("start reviewing");
